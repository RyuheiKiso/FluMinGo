<!-- 新規ファイル: common_api_update_documentation.md の作成 -->
# 共通機能アップデート時の各APIの対応ドキュメント

このドキュメントは、共通機能（common_api）のアップデートが発生した際に、各APIがどのように対応するか、その手順や考慮点をまとめたものです。

## 1. アップデートの基本原則

- **インターフェースの安定性**
  - 各モジュールはインターフェース（契約）に従って実装されているため、共通機能内部の変更がインターフェースに影響しなければ、各APIの利用側は変更する必要がありません。

- **依存性注入（DI）の活用**
  - DIコンテナにより、各APIは抽象層（インターフェース）経由で共通機能に依存しています。これにより、実装の差し替えや修正が容易になり、アップデート時の影響範囲を局所化できます。

- **バージョン管理／後方互換性**
  - 共通機能のインターフェースが変更される場合、APIレベルでのバージョン管理を適用し、既存の契約との後方互換性を確保することが推奨されます。

## 2. 共通機能アップデート時の各APIの対応手順

### 2.1. インターフェース非変更時

- 共通機能内部の実装変更のみの場合、以下の手順で対応します：
  1. 共通機能モジュール内のテストを実施し、変更が意図した結果を生むことを確認。
  2. 各APIはDIコンテナより抽象化されたインターフェースを介して共通機能を利用しているため、API側の修正は不要。
  3. 統合テストを実施して、API全体の動作に問題がないことを確認。

### 2.2. インターフェース変更時

- インターフェース自体の変更が行われた場合、以下の手順で対応します：
  1. **契約の更新**：
     - 共通機能で提供されるインターフェースの契約内容を明示し、変更箇所を全APIチームに通知します。
  2. **API側の修正**：
     - 各APIは新たなインターフェースに適合するように実装の修正またはアダプターの追加を行います。
     - 変更部分は DI コンテナの設定に依存するため、その設定ファイルも更新します。
  3. **テスト実施**：
     - 単体テスト／統合テストを通じて、各APIが新しいインターフェースに正しく対応できていることを確認します。
  4. **段階的ロールアウト**：
     - バージョン管理を活用し、既存クライアントへの影響を最小化するために、旧版と新版の共存期間を設けます。

## 3. ドキュメンテーションとコミュニケーション

- **変更履歴の記録**：
  - 各共通機能のアップデートについて、変更点とその影響範囲（対象API、依存ライブラリ）をドキュメントに記録します。

- **API担当者との連携**：
  - アップデート前に事前ミーティングを開催し、各変更点についての理解と対応方針を共有します。

- **サンプルコードの提供**：
  - 大きな変更の場合は、移行用のサンプルコードやアダプタ実装のテンプレートを提供し、各APIチームの実装をサポートします。

## 4. まとめ

- インターフェースを軸に設計することで、共通機能の内部実装変更はAPI全体に広がる影響を最小限に抑えることが可能です。
- インターフェース変更が必要な場合でも、バージョン管理と段階的な移行により、後方互換性を確保しながらAPIの更新を行います。
- 継続的なテストと担当者間のコミュニケーションが、スムーズな移行・アップデートを支えます。

## 5. 具体的なアップデート手順

### 5.1. アップデート前の準備
- 共通機能の変更内容を詳細にレビューし、影響範囲を特定する。
- 各APIチームとのミーティングを開催し、変更内容の説明とバックアッププランを共有する。
- バージョン管理システム（Gitなど）で、共通機能のブランチを作成する。
- 自動テスト（単体テスト、統合テスト）の最新状態を確認する。

### 5.2. 共通機能の実装変更
- 新機能やバグ修正を共通機能モジュール内で実施する。
- インターフェースが変更されない場合は、内部実装のみを更新し、既存のテストを実行して問題がないことを確認する。
- インターフェースに変更が必要な場合は、変更内容をドキュメント化し、契約の更新を行う。

### 5.3. API側の対応
- DIコンテナの設定ファイルを最新のインターフェースに合わせて更新する。
- 必要に応じて、アダプタやブリッジクラスを新たに実装し、移行期間中は旧インターフェースと共存させる。
- 変更箇所に関しては、各APIチーム内でコードレビューを実施する。

### 5.4. テストと検証
- 共通機能モジュール単体テストを実施し、意図した動作が実現されていることを確認する。
- APIレベルの統合テストを実施し、各APIが新旧インターフェースに正しく対応しているか確認する。
- ローカル環境およびステージング環境で、エンドツーエンド（E2E）テストを実施する。

### 5.5. ロールアウトとフォローアップ
- 段階的なリリース計画を策定し、影響範囲を限定して本番環境へ展開する。
- リリース後、モニタリングツール（ログ、メトリクス、アラート機能）で問題の早期検出を行う。
- 問題発生時は、迅速にロールバックまたは修正パッチを適用する。

## 6. 具体的な操作手順

### 6.1. 共通機能担当者の視点
- **変更ブランチの作成と管理**
  - Gitで共通機能用の専用ブランチを作成する。
  - 新機能、バグ修正ごとにコミットを明確に分割して記録する。

- **環境構築とローカルテスト**
  - 共通機能モジュール単体テストをローカルで実行し、全ケースがパスすることを確認する。
  - ダミーの依存先（モックまたはスタブ）を使用して、API側と連携する前に独立してテストする。

- **インターフェースの検証とドキュメント更新**
  - 公開されている契約（インターフェース）の変更点を詳細にレビューし、必要であればサンプルコードを用意する。
  - インターフェースの変更がある場合は、仕様書及びサンプル実装を更新し、全関係者に通知する。

- **CI/CDパイプラインでの統合テスト**
  - CIツール（例: Jenkins, GitHub Actionsなど）により自動化された統合テストを実行し、共通機能の変更による影響がないかを確認する。
  - テスト結果をログとして残し、後日のレビューに備える。

### 6.2. 個別API側担当者の視点
- **DIコンテナ設定の更新**
  - 共通機能で公開される新しいまたは変更されたインターフェースに合わせ、DIコンテナの設定ファイル（例：`container.go`やFlutterの`injection_container.dart`）を修正する。
  - 古いインターフェースと新しいインターフェースの両方が一時的に共存する場合は、適切なアダプターを用意し、段階的な移行戦略を策定する。

- **コードレビューと定期ミーティング**
  - 各API担当者は、共通機能の変更点についてコードレビューを実施し、修正箇所を明確にする。
  - 共通機能側とAPI側の担当者が連携ミーティングを設定し、変更の意図と実装方法を共有する。

- **テスト環境での統合テスト**
  - ローカル及びステージング環境で、共通機能のアップデート後のAPI全体の動作確認を行う。
  - 自動テストスクリプトを用いて、APIエンドポイントへのリクエスト・レスポンスが期待どおりに動作しているか検証する。

- **リリース計画とロールバック手順の整備**
  - アップデート前に、リリース手順と緊急時のロールバック手順を文書化する。
  - 本番環境へのデプロイ後、定期的に監視ツールでパフォーマンスとエラーログを確認し、異常が発生した場合は迅速に対応する。

## 7. 具体的コマンドと操作例

### 7.1. 共通機能担当者向け
- **Git操作**
  - 変更ブランチの作成例:
    ```bash
    git checkout -b feature/common_update
    ```
  - コミットの分割:
    ```bash
    git add <modified files>
    git commit -m "[auth] インターフェース追加"
    git commit -m "[db] 実装のリファクタリング"
    ```

- **ローカルテスト実行例**
  - 単体テストの実行（Golangの場合）:
    ```bash
    cd FluMinGo/golang/common_api
    go test ./...
    ```
  - 単体テストの実行（Flutterの場合）:
    ```bash
    flutter test
    ```

- **CI/CD設定の確認・実行**
  - CIパイプラインを手動でトリガーし、テスト結果を確認する。（例: GitHub Actionsのワークフロー画面）

### 7.2. 個別API担当者向け
- **DI設定更新**
  - DIファイル（例: `container.go` や `injection_container.dart`）の修正:
    - 旧インターフェースを新しいものに更新。
    - アダプターの追加が必要な場合は、その実装ファイルも作成する。

- **統合テスト実行例**
  - GolangのAPI統合テスト:
    ```bash
    cd FluMinGo/golang/specific_api
    go test ./...
    ```
  - Flutter APIエミュレーションテスト:
    ```bash
    flutter drive --target=test_driver/app.dart
    ```

- **ロールバック手順例**
  - 問題発生時は、Gitで前の安定版にリセット。
    ```bash
    git checkout master
    git reset --hard <安定版のコミットID>
    git push --force
    ```

## 8. 例: シナリオ別対応手順

### 8.1. シナリオA: 共通機能内部実装の更新のみ
1. 共通機能担当者が新実装をブランチにコミット。
2. 単体テスト実施後、CIでの統合テストを通過。
3. 各APIはDIコンテナを通じて既存インターフェースで動作中のため、API側修正は不要。
4. 本番環境へ段階的リリース。

### 8.2. シナリオB: インターフェースに変更が必要な場合
1. 共通機能担当者がインターフェース変更と実装更新を行い、詳細な変更点をドキュメント化。
2. 各APIチームへ変更通知とサンプルコード、場合に応じてアダプター実装のテンプレートを共有。
3. 各API担当者がDI設定および関連コードを更新し、単体・統合テストを実施。
4. 新旧インターフェースの共存期間を設け、段階的移行を実施。
5. 最終的に全APIを新インターフェースに統一し、旧インターフェースを削除。
